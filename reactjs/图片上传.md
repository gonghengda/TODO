### 目录

- [图片上传](#图片上传)

# 图片上传

```
  Cropper.js 

  import React,{Component} from 'react';
  import Cropper from 'react-cropper'; //react-cropper 是图片处理(裁剪)包
  import 'cropperjs/dist/cropper.css';
  import {Modals,Buttons} from 'uiw';
  import 'axios';


  export default class CorpperModal extends Component{
    super(props);
    this.state = {
      src:'',
      visible:false
    }
  }

  readFile = () =>{
    var file = this.refs.fileRef.files[0];
    if(!file) return;
    if(!/^image\/.*$/i.test(file.type)) return;
    var reader = new window.FileReader();
    reader.onloadend = ()=>{
      var src = reader.result;
      this.setState({src:src,,visible:true})
    }
    reader.readAsDataURL(file);
  }


  onOK =()=>{
    if (typeof this.cropper.getCroppedCanvas() === 'undefinded') return;
    var base64 = this.cropper.getCroppedCanvas().toDataURL();
    var blob = this.dataURLtoBlob(base64)
    this.upload(blob)
  }

  dataURLtoBlob = (dataURL)=>{
    var byteString,mimestring;
    if(dataURL.split(',')[0].indexOf('base64') !== -1){
      byteString = atob(dataURL.split(',')[1])
    }else{
      byteString = decodeURL(dataURL.split(',')[1])
    }

    mimestring = dataURL.split(',')[0].split(':')[1].split(';')[0]
    var content = new Array();
    for (var i = 0; i<byteString.length;i++){
      content[i] = byteString.charCodeAt(i)
    }

    return new Blob([new Uint8Array(content)],{type:mimstring});
  }

  upload = (file)=>{
    var data = new FormData();
    data.append('file',file);
    axios.post('/api/v1/file',data).then((res)=>res.data).then((json)=>{
      this.setState({visible:false})
      this.props.onUpload && this.props.onUpload(json)
    }).catch((err)=>{
      console.log(err)
    })
  }

  render(){
    return (
      <div className='Cropper-upload'>
        <Modals
          title='上传裁剪'
          visible={this.state.visible}
          onOK={this.onOK}
          onCancel={()=>{
            this.setState({visible:false})
            this.props.onCancel&&this.props.onCancel()
          }}
          okText={this.props.okText || '确认上传'}
          cancelText={this.props.cancelText || '取消'}
        >
        <Cropper
          ref={(cropper)=> this.cropper = cropper}
          src={this.state.src}
          style={{height:350,width:'100%'}}
          aspectRatio={this.props.ratio || (13/10)}
          guides={false}
          crop={()=>{}}
        >
        </Modals>
        <div>
          <Buttons size='small' type='success' onClick={()=>{this.refs.fileRef.click()}}>上传图片</Buttons>
          <span>上传请注意上传PNG/GIF/JPG格式图片</span>
          <input type='file' onChange={this.readFile} ref='fileRef'>
        </div>
      </div>
    )
  }


```

```
  import React, {Component} from 'react';
  import CropperModal from './Cropper'

  export default class Add extends Component {
    constructor(props){
      super(props)
      imageList,
      form:{
        pic_url:''
      }
    }

    render(){
      const {form} = this.state;
        <Input name="pic_url" 
          value={this.state.form.pic_url} 
          onChange={this.onChange.bind(this,'pic_url')}
          style={{display:"none"}}
        />
        <div className="upload">
          <div className="title">图片上传</div>
          <div className="img-group">
          {
            this.state.form.pic_url&&this.state.form.pic_url.split(',').map((item,i,self)=>{
            return (
              <div key={`image_${i}`} className="img-item">
                <img src={item}/>
                <span className="del" onClick={()=>{this.showDelPicComfirm(i)}}>X</span>
              </div>) })
          }
          </div>
          <div className='group'>
            <CropperModal onUpload={(json)=>{
              if(json.code === 0){
                var imageList = this.state.imageList;
                imageList.push(json.data.path);
                let {form} = this.state;
                form.pic_url = imageList.join(',');
                this.setState({imageList,form})
              }else{
                Message.error(json.message || '图片上传失败')
              }
            }}/>
          </div>
        </div>  
    }
  }
```
